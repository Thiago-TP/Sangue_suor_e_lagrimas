#################################################################
#	esta funcao toca a musica descrita pelo Track1, mas	#
#	pode ser generalizada para tocar qualquer musica dada	#
#################################################################
#	- Inputs -	#
#	nenhum		#
#########################
#	- Outputs -	#
#	nenhum		#
#########################
.data
	# quantidade de notas totais
	NumNotas1: 	.word 126,
	NumNotas2: 	.word 39,
	NumNotas3: 	.word 126,
	NumNotas4: 	.word 126,
	NumNotas5: 	.word 126,
	# lista de nota, duração, nota, duração, nota, duração, ...
	Track1: 79, 441, 87, 441, 86, 441, 87, 441, 80, 441, 80, 441, 84, 441, 92, 441, 80, 441, 86, 441, 87, 441, 89, 441, 79, 441, 79, 441, 84, 441, 91, 441, 75, 441, 75, 441, 84, 441, 84, 441, 75, 441, 91, 441, 80, 441, 89, 441, 74, 441, 74, 441, 77, 441, 89, 441, 83, 441, 86, 441, 83, 441, 86, 441, 79, 441, 87, 441, 86, 441, 87, 441, 80, 441, 80, 441, 84, 441, 92, 441, 79, 441, 86, 441, 87, 441, 89, 441, 79, 441, 79, 441, 84, 441, 91, 441, 75, 441, 75, 441, 84, 441, 84, 441, 75, 441, 91, 441, 80, 441, 89, 441, 74, 441, 74, 441, 77, 441, 89, 441, 83, 441, 86, 441, 86, 882, 75, 441, 75, 441, 79, 441, 84, 441, 91, 441, 91, 441, 92, 441, 89, 441, 74, 441, 74, 441, 79, 441, 83, 441, 91, 441, 91, 441, 92, 441, 89, 441, 79, 441, 79, 441, 83, 441, 79, 441, 91, 441, 91, 441, 98, 441, 91, 441, 72, 441, 89, 441, 75, 441, 79, 441, 84, 441, 87, 441, 84, 441, 87, 441, 74, 441, 74, 441, 79, 441, 92, 441, 74, 441, 74, 441, 79, 441, 86, 441, 79, 441, 79, 441, 91, 882, 79, 441, 79, 441, 84, 441, 84, 441, 77, 441, 77, 441, 80, 441, 77, 441, 77, 441, 89, 441, 80, 441, 87, 441, 72, 441, 72, 441, 75, 441, 72, 441, 74, 441, 74, 441, 77, 441, 86, 441 
	Track2: 64, 1000, 61, 1000, 63, 1000, 60, 1000, 61, 3000, 64, 1000, 64, 1000, 66, 1000, 63, 1000, 60, 1000, 64, 2000, 63, 2000, 61, 2000, 66, 1000, 64, 1000, 63, 2000, 60, 2000, 64, 1000, 66, 1000, 63, 1000, 60, 1000, 64, 2000, 63, 2000, 61, 2000, 66, 1000, 64, 1000, 63, 2000, 60, 2000, 64, 1000, 66, 1000, 63, 1000, 60, 1000, 64, 2000, 63, 2000, 61, 2000, 66, 1000, 64, 1000, 63, 2000, 60, 2000 
	Track3: 79, 441, 87, 441, 86, 441, 87, 441, 80, 441, 80, 441, 84, 441, 92, 441, 80, 441, 86, 441, 87, 441, 89, 441, 79, 441, 79, 441, 84, 441, 91, 441, 75, 441, 75, 441, 84, 441, 84, 441, 75, 441, 91, 441, 80, 441, 89, 441, 74, 441, 74, 441, 77, 441, 89, 441, 83, 441, 86, 441, 83, 441, 86, 441, 79, 441, 87, 441, 86, 441, 87, 441, 80, 441, 80, 441, 84, 441, 92, 441, 79, 441, 86, 441, 87, 441, 89, 441, 79, 441, 79, 441, 84, 441, 91, 441, 75, 441, 75, 441, 84, 441, 84, 441, 75, 441, 91, 441, 80, 441, 89, 441, 74, 441, 74, 441, 77, 441, 89, 441, 83, 441, 86, 441, 86, 882, 75, 441, 75, 441, 79, 441, 84, 441, 91, 441, 91, 441, 92, 441, 89, 441, 74, 441, 74, 441, 79, 441, 83, 441, 91, 441, 91, 441, 92, 441, 89, 441, 79, 441, 79, 441, 83, 441, 79, 441, 91, 441, 91, 441, 98, 441, 91, 441, 72, 441, 89, 441, 75, 441, 79, 441, 84, 441, 87, 441, 84, 441, 87, 441, 74, 441, 74, 441, 79, 441, 92, 441, 74, 441, 74, 441, 79, 441, 86, 441, 79, 441, 79, 441, 91, 882, 79, 441, 79, 441, 84, 441, 84, 441, 77, 441, 77, 441, 80, 441, 77, 441, 77, 441, 89, 441, 80, 441, 87, 441, 72, 441, 72, 441, 75, 441, 72, 441, 74, 441, 74, 441, 77, 441, 86, 441 
	Track4: 79, 441, 87, 441, 86, 441, 87, 441, 80, 441, 80, 441, 84, 441, 92, 441, 80, 441, 86, 441, 87, 441, 89, 441, 79, 441, 79, 441, 84, 441, 91, 441, 75, 441, 75, 441, 84, 441, 84, 441, 75, 441, 91, 441, 80, 441, 89, 441, 74, 441, 74, 441, 77, 441, 89, 441, 83, 441, 86, 441, 83, 441, 86, 441, 79, 441, 87, 441, 86, 441, 87, 441, 80, 441, 80, 441, 84, 441, 92, 441, 79, 441, 86, 441, 87, 441, 89, 441, 79, 441, 79, 441, 84, 441, 91, 441, 75, 441, 75, 441, 84, 441, 84, 441, 75, 441, 91, 441, 80, 441, 89, 441, 74, 441, 74, 441, 77, 441, 89, 441, 83, 441, 86, 441, 86, 882, 75, 441, 75, 441, 79, 441, 84, 441, 91, 441, 91, 441, 92, 441, 89, 441, 74, 441, 74, 441, 79, 441, 83, 441, 91, 441, 91, 441, 92, 441, 89, 441, 79, 441, 79, 441, 83, 441, 79, 441, 91, 441, 91, 441, 98, 441, 91, 441, 72, 441, 89, 441, 75, 441, 79, 441, 84, 441, 87, 441, 84, 441, 87, 441, 74, 441, 74, 441, 79, 441, 92, 441, 74, 441, 74, 441, 79, 441, 86, 441, 79, 441, 79, 441, 91, 882, 79, 441, 79, 441, 84, 441, 84, 441, 77, 441, 77, 441, 80, 441, 77, 441, 77, 441, 89, 441, 80, 441, 87, 441, 72, 441, 72, 441, 75, 441, 72, 441, 74, 441, 74, 441, 77, 441, 86, 441 
	Track5: 79, 441, 87, 441, 86, 441, 87, 441, 80, 441, 80, 441, 84, 441, 92, 441, 80, 441, 86, 441, 87, 441, 89, 441, 79, 441, 79, 441, 84, 441, 91, 441, 75, 441, 75, 441, 84, 441, 84, 441, 75, 441, 91, 441, 80, 441, 89, 441, 74, 441, 74, 441, 77, 441, 89, 441, 83, 441, 86, 441, 83, 441, 86, 441, 79, 441, 87, 441, 86, 441, 87, 441, 80, 441, 80, 441, 84, 441, 92, 441, 79, 441, 86, 441, 87, 441, 89, 441, 79, 441, 79, 441, 84, 441, 91, 441, 75, 441, 75, 441, 84, 441, 84, 441, 75, 441, 91, 441, 80, 441, 89, 441, 74, 441, 74, 441, 77, 441, 89, 441, 83, 441, 86, 441, 86, 882, 75, 441, 75, 441, 79, 441, 84, 441, 91, 441, 91, 441, 92, 441, 89, 441, 74, 441, 74, 441, 79, 441, 83, 441, 91, 441, 91, 441, 92, 441, 89, 441, 79, 441, 79, 441, 83, 441, 79, 441, 91, 441, 91, 441, 98, 441, 91, 441, 72, 441, 89, 441, 75, 441, 79, 441, 84, 441, 87, 441, 84, 441, 87, 441, 74, 441, 74, 441, 79, 441, 92, 441, 74, 441, 74, 441, 79, 441, 86, 441, 79, 441, 79, 441, 91, 882, 79, 441, 79, 441, 84, 441, 84, 441, 77, 441, 77, 441, 80, 441, 77, 441, 77, 441, 89, 441, 80, 441, 87, 441, 72, 441, 72, 441, 75, 441, 72, 441, 74, 441, 74, 441, 77, 441, 86, 441 
.text
Musica:
	addi	sp, sp, -28
	sw	ra, 0(sp)
	sw	a0, 4(sp)
	sw	a1, 8(sp)
	sw	a2, 12(sp)
	sw	a3, 16(sp)	
	sw	a7, 20(sp)
	sw	t6, 24(sp)
	
	la	t6, Fase		# t6 <- endereco do numero da fase
	lb	t6, 0(t6)		# t6 <- numero da fase
	
	# escolha de track de acordo com a fase
	li	t5, 1
	beq	t6, t5, musica1	
	li	t5, 2
	beq	t6, t5, musica2
	li	t5, 3
	beq	t6, t5, musica3
	li	t5, 4
	beq	t6, t5, musica4
	
	la 	t6, Track5		# define o endereço das notas
	la 	t1, NumNotas5		# define o endereço do número de notas
	li 	a2, 5#68		# define o instrumento
	j	fimEscolheTrack
musica1:	
	la 	t6, Track1		# define o endereço das notas
	la 	t1, NumNotas1		# define o endereço do número de notas
	li 	a2, 1#68		# define o instrumento
	j	fimEscolheTrack
musica2:	
	la 	t6, Track2		# define o endereço das notas
	la 	t1, NumNotas2		# define o endereço do número de notas
	li 	a2, 68			# define o instrumento
	j	fimEscolheTrack
musica3:	
	la 	t6, Track3		# define o endereço das notas
	la 	t1, NumNotas3		# define o endereço do número de notas
	li 	a2, 3#68		# define o instrumento
	j	fimEscolheTrack
musica4:	
	la 	t6, Track4		# define o endereço das notas
	la 	t1, NumNotas4		# define o endereço do número de notas
	li 	a2, 4#68		# define o instrumento
fimEscolheTrack:
	lw 	t1, 0(t1)		# le o numero de notas
	la 	t4, noteCounter		# t4 <- label do contador
	lw	t0, 0(t4)		# t0 <- o contador de notas (importante no jogo)
	beq 	t0, t1, musicEnd	# contador chegou no final? então  vá para FIM
	
	li	t5, 8			# t5 <- 8 = num de bytes num par (nota, duracao)
	mul	t5, t5, t0		# t5 <- q. de pares lidos ate agora
	add	t5, t5, t6		# t5 <- endereco da nota atual
	
	lw 	a1, 4(t5)		# a1 <- duracao da nota	
	
 	la	t2, musicTime
 	csrr 	t1, time		# tempo atual em ms	
	lw	t3, 0(t2)		# t3 <- tempo em ms desde a ultima nota
	sub	t3, t1, t3		# t3 <- tempo atual - ultima nota
	bltu 	t3, a1, pulaNota	# ultima nota nao terminou? retorna : toca a proxima nota 

	sw	t1, 0(t2)		# tempo eh atualizado
	addi 	t0, t0, 1		# incrementa o contador de notas
	sw	t0, 0(t4)
	
	lw 	a0, 0(t5)		# le o valor da nota
	li 	a3, 80			# define o volume
	li 	a7, 31			# define a chamada de syscall (trocar quando for usar FPGA)
	ecall				# toca a nota
	#call	midiOut
	
	j 	pulaNota		# volta ao loop do jogo
musicEnd:				# musica acabou -> tocamos tudo de novo
	sw	zero, 0(t4)		# contador de notas eh zerado
pulaNota:				# retorno da funcao
	lw	ra, 0(sp)
	lw	a0, 4(sp)
	lw	a1, 8(sp)
	lw	a2, 12(sp)
	lw	a3, 16(sp)	
	lw	a7, 20(sp)
	lw	t6, 24(sp)
	addi	sp, sp, 28
	ret


